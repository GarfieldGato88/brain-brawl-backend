const io = require('socket.io-client');
const readline = require('readline');

// Create readline interface for user input
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

let socket;
let currentRoom = null;
let isHost = false;
let currentQuestion = null;

// Test JWT token (you'll need to get this from a real login)
const TEST_TOKEN = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsInVzZXJuYW1lIjoiVGVzdFBsYXllcjEiLCJlbWFpbCI6InRlc3RAZXhhbXBsZS5jb20iLCJpYXQiOjE3MzQzNjcxMjMsImV4cCI6MTczNDQ1MzUyM30.abc123def456...'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsInVzZXJuYW1lIjoidGVzdHBsYXllciIsImVtYWlsIjoidGVzdEBleGFtcGxlLmNvbSIsImlhdCI6MTczNDM2MzY4NCwiZXhwIjoxNzM0NDUwMDg0fQ.example'; // This is just a placeholder

console.log('ðŸŽ® Brain Brawl Socket.io Test Client');
console.log('=====================================\n');

function connectToServer() {
  console.log('ðŸ”Œ Connecting to server...');
  
  socket = io('http://localhost:5000', {
    auth: {
      token: TEST_TOKEN
    },
    transports: ['websocket', 'polling']
  });

  // Connection events
  socket.on('connect', () => {
    console.log('âœ… Connected to server!');
    console.log('Socket ID:', socket.id);
    showMenu();
  });

  socket.on('connect_error', (error) => {
    console.error('âŒ Connection failed:', error.message);
    console.log('ðŸ’¡ Make sure your server is running with: npm run dev');
    console.log('ðŸ’¡ You might need a valid JWT token for authentication');
    process.exit(1);
  });

  socket.on('disconnect', (reason) => {
    console.log('ðŸ‘‹ Disconnected from server:', reason);
  });

  // Room events
  socket.on('room_created', (data) => {
    console.log('\nðŸ  Room created successfully!');
    console.log('ðŸ“‹ Room Code:', data.code);
    console.log('ðŸ‘‘ You are the host');
    console.log('ðŸ‘¥ Players:', data.players.length);
    
    currentRoom = data.code;
    isHost = data.isHost;
    showRoomMenu();
  });

  socket.on('room_joined', (data) => {
    console.log('\nðŸšª Joined room successfully!');
    console.log('ðŸ“‹ Room Code:', data.code);
    console.log('ðŸ‘‘ Host:', data.isHost ? 'You' : 'Someone else');
    console.log('ðŸ‘¥ Players:', data.players.length);
    
    currentRoom = data.code;
    isHost = data.isHost;
    showRoomMenu();
  });

  socket.on('player_joined', (data) => {
    console.log('\nðŸ‘¤ New player joined!');
    console.log('Player:', data.player.username);
    console.log('ðŸ‘¥ Total players:', data.players.length);
  });

  socket.on('player_left', (data) => {
    console.log('\nðŸ‘‹ Player left');
    console.log('Player ID:', data.playerId);
    console.log('ðŸ‘¥ Remaining players:', data.players.length);
  });

  // Game events
  socket.on('game_started', (data) => {
    console.log('\nðŸš€ Game started!');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    displayQuestion(data);
    currentQuestion = data;
  });

  socket.on('next_question', (data) => {
    console.log('\nâž¡ï¸ Next question!');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    displayQuestion(data);
    currentQuestion = data;
  });

  socket.on('answer_result', (data) => {
    console.log('\nðŸ“Š Answer Result:');
    console.log('âœ… Correct:', data.isCorrect ? 'YES' : 'NO');
    console.log('ðŸ† Points earned:', data.points);
    console.log('ðŸ“ˆ Your total score:', data.yourScore);
    console.log('ðŸ’¬ Comment:', data.snarkComment);
    console.log('ðŸŽ¯ Correct answer was:', data.correctAnswer);
    
    if (isHost) {
      console.log('\nâ±ï¸ Press Enter to continue to next question...');
    }
  });

  socket.on('game_finished', (data) => {
    console.log('\nðŸ Game finished!');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('ðŸ† Final Leaderboard:');
    data.leaderboard.forEach((player, index) => {
      const medal = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : 'ðŸƒ';
      console.log(`${medal} ${index + 1}. ${player.username}: ${player.score} points (${player.correctAnswers}/${player.totalAnswers} correct)`);
    });
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    currentRoom = null;
    isHost = false;
    currentQuestion = null;
    showMenu();
  });

  // Error events
  socket.on('error', (data) => {
    console.error('\nâŒ Error:', data.message);
    if (currentRoom) {
      showRoomMenu();
    } else {
      showMenu();
    }
  });
}

function displayQuestion(data) {
  console.log(`â“ Question ${data.questionNumber}/${data.totalQuestions}`);
  console.log(`ðŸ“š Category: ${data.category}`);
  console.log(`â° Time limit: ${data.timeLimit / 1000} seconds`);
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log(`Q: ${data.question}`);
  console.log('');
  console.log('A) ' + data.options[0]);
  console.log('B) ' + data.options[1]);
  console.log('C) ' + data.options[2]);
  console.log('D) ' + data.options[3]);
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('Type A, B, C, or D to answer:');
}

function showMenu() {
  console.log('\nðŸ“‹ Main Menu:');
  console.log('1. Create Room');
  console.log('2. Join Room');
  console.log('3. Get Room Info');
  console.log('4. Exit');
  console.log('\nChoose an option (1-4):');
}

function showRoomMenu() {
  console.log('\nðŸ  Room Menu:');
  console.log('ðŸ“‹ Room Code:', currentRoom);
  console.log('ðŸ‘‘ Host:', isHost ? 'You' : 'Someone else');
  
  if (isHost) {
    console.log('1. Start Game');
    console.log('2. Leave Room');
    console.log('3. Get Room Info');
    console.log('\nChoose an option (1-3):');
  } else {
    console.log('1. Leave Room');
    console.log('2. Get Room Info');
    console.log('\nChoose an option (1-2) or wait for host to start:');
  }
}

function handleInput(input) {
  const choice = input.trim();
  
  // Handle answers during game
  if (currentQuestion && ['A', 'B', 'C', 'D'].includes(choice.toUpperCase())) {
    const timeSpent = Math.floor(Math.random() * 10000) + 1000; // Random time 1-11 seconds
    console.log(`ðŸ“ Submitting answer: ${choice.toUpperCase()}`);
    socket.emit('submit_answer', { 
      answer: choice.toUpperCase(), 
      timeSpent: timeSpent 
    });
    return;
  }
  
  // Handle next question (host only)
  if (currentQuestion && choice === '' && isHost) {
    console.log('â­ï¸ Moving to next question...');
    socket.emit('next_question');
    return;
  }
  
  // Handle room menu
  if (currentRoom) {
    if (isHost) {
      switch (choice) {
        case '1':
          console.log('ðŸš€ Starting game...');
          socket.emit('start_game');
          break;
        case '2':
          console.log('ðŸšª Leaving room...');
          socket.emit('leave_room');
          currentRoom = null;
          isHost = false;
          showMenu();
          break;
        case '3':
          console.log('ðŸ“Š Getting room info...');
          socket.emit('get_room_info');
          break;
        default:
          console.log('âŒ Invalid choice');
          showRoomMenu();
      }
    } else {
      switch (choice) {
        case '1':
          console.log('ðŸšª Leaving room...');
          socket.emit('leave_room');
          currentRoom = null;
          isHost = false;
          showMenu();
          break;
        case '2':
          console.log('ðŸ“Š Getting room info...');
          socket.emit('get_room_info');
          break;
        default:
          console.log('âŒ Invalid choice');
          showRoomMenu();
      }
    }
    return;
  }
  
  // Handle main menu
  switch (choice) {
    case '1':
      console.log('ðŸ  Creating room...');
      socket.emit('create_room');
      break;
    case '2':
      console.log('Enter room code (6 digits):');
      rl.question('Room code: ', (code) => {
        console.log(`ðŸšª Joining room ${code}...`);
        socket.emit('join_room', { code: code });
      });
      break;
    case '3':
      console.log('ðŸ“Š Getting room info...');
      socket.emit('get_room_info');
      break;
    case '4':
      console.log('ðŸ‘‹ Goodbye!');
      process.exit(0);
      break;
    default:
      console.log('âŒ Invalid choice');
      showMenu();
  }
}

// Handle user input
rl.on('line', handleInput);

// Handle Ctrl+C
process.on('SIGINT', () => {
  console.log('\nðŸ‘‹ Disconnecting...');
  if (socket) {
    socket.disconnect();
  }
  process.exit(0);
});

// Start the client
connectToServer();